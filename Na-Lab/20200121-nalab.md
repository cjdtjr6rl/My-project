# My Na-Lab Project

<br/>

## <Now Project -> 게시판 생성>

<br/>

### 목차

1. [게시판 설정](#main)
2. [게시판 선택](#select)
3. [게시판 추가버튼 활성화](#insert)
4. [게시판 삭제버튼 활성화](#del)
5. [게시판 이름 수정](#edit)
6. [정보 저장](#save)

--------

1. 게시판 설정<a id="main"></a>

   게시판을 설정하는 페이지의 UI입니다.

   ![게시판 추가 버튼](https://user-images.githubusercontent.com/43205396/72734220-a24caf80-3bdc-11ea-8532-714bbcdc9db5.png)

   ```html
   <div id="itemBoxWrap">
   	<%-- 게시판 리스트 출력 --%>
   	<ul id="sortable">
   	<c:forEach items="${selectlabboard}" var="board">
   				<c:if test="${board.board_type eq user_info.board1 || board.board_type eq user_info.board2}">
   					<li class="ui-state-default tooltips b_item" onclick="setTarget('${board.board_num}')" id="${board.board_num}" data-board_title="${board.board_title}" data-delete_division="${board.delete_division}" data-ismain="true" data-flag="${board.flag}" data-isnew="false" data-writeauth="${board.write_auth}" >
   						<span>${board.board_title}</span> &nbsp;
   					</li>
   		</c:if>
   		<c:if test="${board.board_type ne user_info.board1 && board.board_type ne user_info.board2}">
   					<li class="ui-state-default tooltips b_item" onclick="setTarget('${board.board_num}')" id="${board.board_num}" data-board_title="${board.board_title}" data-delete_division="${board.delete_division}" data-ismain="false" data-flag="${board.flag}" data-isnew="false" data-writeauth="${board.write_auth}" >
   						<span>${board.board_title}</span> &nbsp;
   			</li>
   		</c:if>
   	</c:forEach>
   	</ul>
   	<%-- 게시판 리스트 출력 end--%>
   </div>
   ```

   게시판 정보 리스트 중에서 LabMain 화면에 등록이 되어 있는 게시판이라면 삭제를 할 수 없도록 ismain값이 true로 지정을 하며, 게시판에 등록이 되어 있지 않다면 ismain값이 false로 지정을 하여 삭제를 할 수 있도록 구분을 두었습니다.

   <br/>

   ---

2. 게시판 선택<a id="select"></a>

   리스트로 출력되는 게시판을 클릭하면 게시판 정보가 오른쪽에 출력하게 됩니다.

   ```html
   <table class="table">
   	<tr>
   		<td>게시판 이름:</td>
   		<td><input type="text" id="intext" value=""></td>
   	</tr>
   	<tr>
   		<td>종류</td>
   		<td>
   			<label class="radio"><input type="radio" name="boardType" value="report" id="report" class="boardTypeRadio b_info_view" ><i class="rounded-x"></i>과제</label>&nbsp;
   			<label class="radio"><input type="radio" name="boardType" value="default" id="default" class="boardTypeRadio b_info_view"><i class="rounded-x"></i>일반</label>
   		</td>
   	</tr>
   		<tr>
   			<td>쓰기권한</td>
   			<td>
   			<label class="radio"><input type="radio" name="writeAuth" value="3" id="writeAuth3" class="b_info_view"><i class="rounded-x"></i>관리자</label>&nbsp;
   			<label class="radio"><input type="radio" name="writeAuth" value="1" id="writeAuth1" class="b_info_view"><i class="rounded-x"></i>모든사용자</label>
   		</td>
   	</tr>
   </table>
   ```

   게시판의 종류, 게시판 쓰기권한을 제한을 두어 구분을 하게 하였습니다.<br/>

   아래는 선택한 게시판의 정보들을 불러와 출력하는 script입니다.

   ```javascript
   // 게시판 타겟 설정
   function setTarget(id){
   	var $target = $('#'+id);
   	// 클릭 한 게시판 표시 상태 변경 - 게시판 리스트 중 클릭 상태인 class를 찾아서 클릭 상태 해제 후 클릭 한 게시판만 클릭 상태 표시
   	$('.b_item').each(function(){
   		$(this).attr('class','ui-state-default tooltips b_item');
   	});
   	$target.toggleClass('text-highlights text-highlights-gray');
   
   	// 선택된 게시판의 속성 정보 가져오기
   	target_board_info.board_num = id;
   	target_board_info.board_title = $target.data("board_title");
   	target_board_info.delete_division = $target.data("delete_division");
   	target_board_info.writeAuth = $target.data("writeauth");
   	target_board_info.isMain = $target.data("ismain");
   	target_board_info.isNew = $target.data("isnew");
   	target_board_info.flag = $target.data("flag");
   
   	// 게시판 정보 뷰 세팅
   	$("#intext").val(target_board_info.board_title);
   	$("#"+target_board_info.delete_division).attr('checked',true);
   	$("#writeAuth"+target_board_info.writeAuth).attr('checked',true);
   	$("#"+target_board_info.delete_division).prop("checked", true);
   	$("#writeAuth"+target_board_info.writeAuth).prop('checked',true);
   
   	if(target_board_info.isNew == true){
   		$('.boardTypeRadio').attr("disabled",false);
   	} else {
   		$('.boardTypeRadio').attr("disabled",true);
   	}
   }
   ```

   새로운 게시판일 경우 isNew가 true 이므로 radio 버튼이 전부 활성화가 되지만 기존에 있는 게시판일 경우 false 이므로 name이 boardTypeRadio가 비활성화 됩니다.

   <br/>

   ---

3. 게시판 추가버튼 활성화<a id="insert"></a>

   게시판을 새로 추가하기 위해선 <button value="추가">추가</button>버튼을 눌러줍니다. 추가를 하게되면 새로이 게시판 안에 새로운 게시판이라고 생성이 됩니다.

   ```javascript
   // 게시판 추가
   function add(){
   	target_board_info = {};
   	var new_board_code = 'new'+new_board_code_cnt;
   
   	// 새로운 게시판의 정보를 입력합니다.
   	var html = '<li class="ui-state-default tooltips b_item" 											onclick="setTarget(\''+new_board_code+'\')" id="'+new_board_code+'" 					data-board_title="새로운 게시판"><span>새로운 게시판</span></li>';
   	$('#sortable').append(html);
   	setTarget(new_board_code);
   	new_board_code_cnt++;
   }
   ```

   add라는 function이 실행하게 되어 새로 만들어진 게시판의 이름은 새로운 게시판이라고 하며, new를 붙인 count 수를 두어 여러개를 만들 시 여러개가 생성되어 들어갈 수 있도록 구현을 하였습니다.<br/>

   아래의 사진은 새롭게 추가를 한 게시판의 모습입니다.

   ![게시판 추가](https://user-images.githubusercontent.com/43205396/72768988-7f51e800-3c3c-11ea-84a5-062294669482.PNG)

   <br/>

   ---

4. 게시판 삭제버튼 활성화<a id="del"></a>

   게시판을 삭제하기 위해선 <button value="삭제">삭제</button>버튼을 눌러줍니다. 삭제를 하게되면 기존에 생성이 되어있는 게시판 뿐 아니라 새로 만든 게시판도 삭제가 가능합니다.

   ```javascript
   //게시판 삭제
   function del(){
   
   	if(target_board_info.board_num === undefined){
   		alert("게시판을 선택해주세요.");
   		return;
   	}
   
   	if(target_board_info.isMain){
   		alert("기본으로 설정된 게시판입니다. 삭제할 수 없습니다.");
   		return;
   	}
   
   	if(!target_board_info.isNew){
   		if(!confirm("해당 게시판의 모든 글이 삭제됩니다.\n그래도 삭제 하시겠습니까?")){
   			return;
   		}
   		$('#b_form').append("<input type='hidden' value='"+target_board_info.board_num+"' name='del_board_code'>");
   	}
   
   	$("#"+target_board_info.board_num).remove();
   
   	$('#intext').val('');
   	$('.b_info_view').each(function(){
   		var type = $(this).attr('type');
   		if(type == 'radio'){
   			$(this).attr('checked',false);
   		}
   	});
   
   	target_board_info = {};
   }
   ```

   board_num이 undifined일 때 게시판이 선택이 되지 않았으므로 경고창이 뜨며, main에 등록이 되어있는 게시판일 경우 삭제가 되지 않는다고 뜹니다. 그리고 만약에 게시판을 삭제를 하고자 한다면 전부 내용이 삭제가 된다는 경고창과 함께 삭제가 진행됩니다.

   <br/>

   ---

5. 게시판 이름 수정<a id="edit"></a>

   - 게시판 이름 수정<a id="edit"></a>

   게시판의 이름을 변경하고 싶은데 게시판의 이름을 수정을 할 때, 구분을 하는 board_num이 배열값으로 들어가 제대로 insert가 되지 않는 현상이 있었습니다.

   ```javascript
   //게시판 이름 변경
       $(document).on('focus','#intext',function(){
           if(target_board_info.board_num === undefined){
               $(this).blur();
           } else {
               $(this).on('keyup', function(){
                   var value = $.trim($(this).val());
                   var spCheck = /[?&]/g;
                   if(spCheck.test(value)) {
                       alert('해당 특수문자는 사용할수 없습니다.');
                       $(this).val(value.replace(/[?&]/g, ""));
                   }
                   $('#'+target_board_info.board_num).children().text(value);
                   $('#'+target_board_info.board_num).data('board_title',value);
               });
           }
       });
   ```

   이와 같이 수정을 하였고, 오류가 날 수 있는 문자 '&'와 '?'는 입력 시 경고창과 함께 replace되게 만들었습니다.

   <br/>

   ---

6. 정보 저장<a id="save"></a>

   게시판을 삭제, 추가, 수정과 같은 정보들을 구성을 하고 나서 적용이라는 버튼을 누르게 된다면 모든 변경 사항이 저장이 됩니다.

   ```html
   <form action="${pageContext.request.contextPath}/updateRoomBoard.do" method="post" onsubmit="return done();" id="b_form">
   	<c:forEach items="${money_total }" var="money_total" varStatus="status">
   		<input type="hidden" value="${money_total.lab_code}" name="lab_code">
   	</c:forEach>
   	<input type="submit" name="submit" value="적용" class="btn btn-facebook ladda-button btn-block" data-style="zoom-in">
   </form>
   ```

   ### member.controller 중 updateRoomBoard 부분

   ```controller
   @RequestMapping(value="/updateRoomBoard.do")
   public ModelAndView updateRoomBoard(CommandMap commandMap, HttpServletRequest req) throws Exception{
   	ModelAndView mv = new ModelAndView("redirect:/labboard_insert.do");
   
   	memberService.updateRoomBoard(commandMap.getMap());
   	mv.addObject("lab_code", commandMap.get("lab_code"));
   	mv.addObject("bbf","300");
   	return mv;
   }
   ```

   <br/>

   ### member.ServiceImpl 중 updateRoomBoard 부분

   ```impl
   @Override
   public void updateRoomBoard(Map<String, Object> map) throws Exception {
   
   	if(map.containsKey("board_num") == false){
   		return;
   	}
   
   	Map<String,Object> TempMap = new HashMap<String,Object>();
   	String roomcode = (String)map.get("roomcode");
   	String board_num[] = (String[]) map.get("board_num");
   	String board_title[] = (String[])map.get("board_title");
   	String write_auth[] = (String[])map.get("write_auth");
   	String delete_division[] = (String[])map.get("delete_division");
   
   	if(map.containsKey("del_board_code") == true){
   		if(map.get("del_board_code") instanceof String[]){
   			String del_board_code[] = (String[])map.get("del_board_code");
   
   			for(int i=0;i<del_board_code.length;i++){
   
   				TempMap.put("board_num",del_board_code[i]);
   				memberDAO.deleteRoomBoard(TempMap);
   			}
   		} else if(map.get("del_board_code") instanceof String){
   			String del_board_code = (String)map.get("del_board_code");
   			TempMap.put("board_num",del_board_code);
   			memberDAO.deleteRoomBoard(TempMap);
   		}
   	}
   
   	for(int i=0;i<board_num.length;i++){
   
   		TempMap.put("roomcode",roomcode);
   		TempMap.put("board_num",board_num[i]);
   		TempMap.put("board_title",board_title[i]);
   		TempMap.put("write_auth",write_auth[i]);
   		TempMap.put("delete_division",delete_division[i]);
   		TempMap.put("board_order",i+1);
   
   		// board_num에서 new라는 값이 들어가 있을 때와 아닐 때
   		if(board_num[i].startsWith("new")){
   			memberDAO.insertRoomBoard(TempMap);
   		} else {
   			memberDAO.updateRoomBoard(TempMap);
   		}
   
   	}
   }
   ```

   updateRoomBoard에서 모든 값을 가져와 조건에 맞춰 insert, update, delete하여 각각의 sql문에 들어가도록 구현하였습니다.

   아래는 sql문 입니다.

   ```sql
   <insert id="insertRoomBoard" parameterType="hashmap">
   	<![CDATA[
   		INSERT INTO
   			board_info
   			(
   				board_type,
   				board_title,
   				board_order,
   				delete_division,
   				lab_code,
   				write_auth,
   				flag
   			)
   		VALUES
   			(
   				#{board_type},
   				#{board_title},
   				#{board_order},
   				#{delete_division},
   				#{lab_code},
   				#{write_auth},
   				'0'
   			)
   	]]>
   </insert>
   
   <delete id="deleteRoomBoard" parameterType="hashmap">
   	<![CDATA[
   		DELETE
   
   		FROM
   			board_info
   		WHERE
   			board_num = #{board_num}
   	]]>
   </delete>
   
   <update id="updateRoomMain" parameterType="hashmap">
       <![CDATA[
   		UPDATE lab_info
   		SET
   			board1 = #{board_type1}, board2 = #{board_type2}
   		WHERE
   			lab_code = #{lab_code}
   	]]>
   </update>
   ```